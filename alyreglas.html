<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <script src="./pseudoRandomNumerGenerators.js"></script>
    <title>Generador de Números Pseudoaleatorios con Pruebas Estadísticas</title>
</head>
<body>
    <div class="container">
        <h1>Generador de Números Pseudoaleatorios con Pruebas Estadísticas</h1>
        
        <div class="tab-buttons">
            <button onclick="openTab('generation')" class="active">Generación</button>
            <button onclick="openTab('testing')">Pruebas Estadísticas</button>
        </div>
        
        <div id="generation" class="tab active">
            <div class="input-group">
                <label for="method">Método:</label>
                <select id="method">
                    <option value="middleSquare">Parte Central del Cuadrado</option>
                    <option value="lehmer">Lehmer</option>
                    <option value="mixedCongruential">Congruencial Mixto</option>
                    <option value="multiplicativeCongruential">Congruencial Multiplicativo</option>
                    <option value="additiveCongruential">Congruencial Aditivo</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="seed">Semilla (n0):</label>
                <input type="number" id="seed" min="1" value="1234">
            </div>
            
            <div class="input-group">
                <label for="digits">Número de dígitos (N):</label>
                <input type="number" id="digits" min="1" max="10" value="4">
            </div>
            
            <div class="input-group">
                <label for="count">Cantidad de números:</label>
                <input type="number" id="count" min="1" value="10">
            </div>
            
            <button class="buttom" onclick="generateNumbers()">Generar Números</button>
            
            <table id="results">
                <thead>
                    <tr>
                        <th>Iteración</th>
                        <th>Número Generado</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
        
        <div id="testing" class="tab">
            <div class="input-group">
                <label for="numbersInput">Números para probar (separados por comas):</label>
                <textarea id="numbersInput" placeholder="Ejemplo: 0.123456, 0.654321, 0.987654"></textarea>
            </div>
            
            <div class="input-group">
                <label>Opciones:</label>
                <button onclick="useGeneratedNumbers()">Usar números generados</button>
                <button onclick="clearNumbers()">Limpiar</button>
            </div>
            
            <div class="input-group">
                <label for="testMethod">Prueba estadística:</label>
                <select id="testMethod">
                    <option value="mean">Prueba de los Promedios</option>
                    <option value="frequency">Prueba de la Frecuencia</option>
                    <option value="series">Prueba de la Serie</option>
                    <option value="ks">Prueba de Kolmogorov-Smirnov</option>
                    <option value="runs">Prueba de Corridas Arriba/Abajo de la Media</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="alpha">Nivel de significancia (α):</label>
                <select id="alpha">
                    <option value="0.01">0.01</option>
                    <option value="0.05" selected>0.05</option>
                    <option value="0.10">0.10</option>
                </select>
            </div>
            
            <button onclick="runTest()">Ejecutar Prueba</button>
            
            <div id="testResult" class="test-result"></div>
        </div>
    </div>

    <script>
        let generatedNumbers = [];
        
        //revisado
        const openTab = (tabName) => {
            const tabs = document.getElementsByClassName('tab'); //busca los divs con clase 'tab'
            const buttons = document.querySelectorAll('.tab-buttons button');

            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active'); //oculta todos los tabs
            }

            buttons.forEach(btn => btn.classList.remove('active')); // quita la clase "active" de todos los botones

            document.getElementById(tabName).classList.add('active'); //muestra el seleccionado

             // Activar el botón correspondiente
            const activeButton = document.querySelector(`.tab-buttons button[onclick="openTab('${tabName}')"]`);
            if (activeButton) activeButton.classList.add('active');
        }
        
        //revisado
        const generateNumbers = () =>{
            const method = document.getElementById("method").value;
            const seed = parseInt(document.getElementById("seed").value);
            const count = parseInt(document.getElementById("count").value);
            
            let results = [];
            
            switch (method) {
                case "middleSquare":
                    results = middleSquareMethod(seed, count);
                    break;
                case "lehmer":
                    results = lehmerMethod(seed, count);
                    break;
                case "mixedCongruential":
                    results = mixedCongruentialMethod(seed, count);
                    break;
                case "multiplicativeCongruential":
                    results = multiplicativeCongruentialMethod(seed, count);
                    break;
                case "additiveCongruential":
                    results = additiveCongruentialMethod(seed, count);
                    break;
                default:
                    alert("Método no válido");
                    return;
            }
            
            generatedNumbers = results.slice();
            displayResults(results);
        }
        
        // Mostrar resultados en la tabla
        function displayResults(results) {
            const tbody = document.getElementById("resultsBody");
            tbody.innerHTML = "";
            
            results.forEach((value, index) => {
                const row = document.createElement("tr");
                
                const iterationCell = document.createElement("td");
                iterationCell.textContent = index + 1;
                
                const valueCell = document.createElement("td");
                valueCell.textContent = value.toFixed(6);
                
                row.appendChild(iterationCell);
                row.appendChild(valueCell);
                tbody.appendChild(row);
            });
        }
        
        function useGeneratedNumbers() {
            if (generatedNumbers.length === 0) {
                alert("No hay números generados para usar.");
                return;
            }
            
            const numbersStr = generatedNumbers.map(num => num.toFixed(6)).join(", ");
            document.getElementById("numbersInput").value = numbersStr;
        }
        
        function clearNumbers() {
            document.getElementById("numbersInput").value = "";
        }
        
        function parseInputNumbers() {
            const input = document.getElementById("numbersInput").value;
            if (!input.trim()) {
                alert("Por favor ingrese números para probar.");
                return null;
            }
            
            const numbersStr = input.split(",");
            const numbers = [];
            
            for (let str of numbersStr) {
                const num = parseFloat(str.trim());
                if (isNaN(num)) {
                    alert(`Valor inválido encontrado: "${str}"`);
                    return null;
                }
                if (num < 0 || num > 1) {
                    alert(`Los números deben estar entre 0 y 1. Valor inválido: ${num}`);
                    return null;
                }
                numbers.push(num);
            }
            
            if (numbers.length < 5) {
                alert("Se necesitan al menos 5 números para realizar pruebas estadísticas.");
                return null;
            }
            
            return numbers;
        }
        
        function runTest() {
            const numbers = parseInputNumbers();
            if (!numbers) return;
            
            const testMethod = document.getElementById("testMethod").value;
            const alpha = parseFloat(document.getElementById("alpha").value);
            
            let result;
            
            switch (testMethod) {
                case "mean":
                    result = averagesTest(numbers, alpha);
                    break;
                case "frequency":
                    result = frequencyTest(numbers, alpha);
                    break;
                case "series":
                    result = seriesTest(numbers, alpha);
                    break;
                case "ks":
                    result = kolmogorovSmirnovTest(numbers, alpha);
                    break;
                case "runs":
                    result = runsAboveBelowMeanTest(numbers, alpha);
                    break;
                default:
                    alert("Prueba no válida");
                    return;
            }
            
            displayTestResult(result);
        }
        
        //revisado
        // Prueba de los Promedios
        const averagesTest = (numbers, alpha) => {
            const n = numbers.length;
            const numbersAverage = numbers.reduce((sum, num) => sum + num, 0) / n; //calcula el promedio de los numeros

            // Valor esperado para una distribución uniforme (0,1) es 0.5
            const expectedAverage = 0.5;

            // Varianza teórica para una distribución uniforme (0,1) es 1/12
            const variance = 1/12;

            // Error estándar de la media
            const stdError = Math.sqrt(variance / n);

            // Estadístico Z, que mide cuán lejos está tu promedio del esperado (0.5), en función del error estándar.
            const z = (numbersAverage - expectedAverage) / stdError;

            // Valor crítico Z (dos colas)
            let criticalValue;
            if (alpha === 0.01) criticalValue = 2.576;
            else if (alpha === 0.05) criticalValue = 1.96;
            else criticalValue = 1.645; // alpha = 0.10

            const passed = Math.abs(z) <= criticalValue;

            return {
                testName: "Prueba de los Promedios",
                n: n,
                mean: numbersAverage,
                expectedMean: expectedAverage,
                zValue: z,
                criticalValue: criticalValue,
                alpha: alpha,
                passed: passed,
                conclusion: passed ? 
                    "Los números pasan la prueba de promedios (no hay evidencia para rechazar la hipótesis de uniformidad)" :
                    "Los números NO pasan la prueba de promedios (se rechaza la hipótesis de uniformidad)"
            };
        }
        
        //revisado
        // Prueba de la Frecuencia (Chi-cuadrado)
        const frequencyTest = (numbers, alpha)=> {
            const n = numbers.length; //tamano de la muestra
            const k = Math.floor(Math.sqrt(n)); // número de intervalos (regla de Sturges simplificada)

            const intervalSize = 1 / k; //se calcula el tamano de los intervalos
        
            const observedFrecuencies = new Array(k).fill(0); //Array de Frecuencias observadas, llenas con 0.
        
            for (const num of numbers) { //recorre todos los números generados.
                const index = Math.min(Math.floor(num / intervalSize), k - 1); //calcula en qué intervalo cae dividiendo el número por el tamaño del intervalo y usa Math.floor() para obtener el índice del intervalo.
                observedFrecuencies[index]++;
            }

            const expectedFrecuency = n / k; //se calcula la Frecuencia esperada
        
            // Calcular chi-cuadrado
            let chiSquared = 0;
            for (let i = 0; i < k; i++) {
                chiSquared += Math.pow(observedFrecuencies[i] - expectedFrecuency, 2) / expectedFrecuency;
            }

            // Grados de libertad
            const df = k - 1;

            // Valores críticos aproximados para chi-cuadrado
            let criticalValue;
            if (alpha === 0.01) {
                if (df === 4) criticalValue = 13.28;
                else if (df === 5) criticalValue = 15.09;
                else if (df === 6) criticalValue = 16.81;
                else criticalValue = df + 3 * Math.sqrt(2 * df); // Aproximación para otros valores
            } else if (alpha === 0.05) {
                if (df === 4) criticalValue = 9.49;
                else if (df === 5) criticalValue = 11.07;
                else if (df === 6) criticalValue = 12.59;
                else criticalValue = df + 2 * Math.sqrt(2 * df); // Aproximación para otros valores
            } else { // alpha = 0.10
                if (df === 4) criticalValue = 7.78;
                else if (df === 5) criticalValue = 9.24;
                else if (df === 6) criticalValue = 10.64;
                else criticalValue = df + Math.sqrt(2 * df); // Aproximación para otros valores
            }

            const passed = chiSquared <= criticalValue;

            return {
                testName: "Prueba de la Frecuencia (Chi-cuadrado)",
                n: n,
                k: k,
                chiSquared: chiSquared,
                criticalValue: criticalValue,
                alpha: alpha,
                passed: passed,
                conclusion: passed ?
                    "Los números pasan la prueba de frecuencia (no hay evidencia para rechazar la hipótesis de uniformidad)" :
                    "Los números NO pasan la prueba de frecuencia (se rechaza la hipótesis de uniformidad)"
            };
        }
        
        //revisado
        // Prueba de la Serie
        const seriesTest = (numbers, alpha)=> {
            const n = numbers.length;
            const x = Math.floor(Math.sqrt(n - 1)); //se busca un valor de x apropiado
   
            if (x < 2) {
                return {
                    testName: "Prueba de la Serie",
                    error: "No hay suficientes números para realizar la prueba de serie. Se necesitan al menos 4 pares de números."
                };
            }

            const expectedFrecuency = (n-1) / Math.pow(x, 2);
        
            // Crear matriz de frecuencias observadas de celdas x^2 
            const observedFrecuencies = Array.from({ length: x }, () => new Array(x).fill(0));

            // Armar los pares consecutivos y contar en que celda caen
            for (let i = 0; i < n - 1; i ++) {
                const num1 = numbers[i];
                const num2 = numbers[i + 1];

                const index1 = Math.min(Math.floor(num1 * x), x - 1); //obtiene el indice del intervalo de 0 a 1 en el que cae cada numero, el segundo valor es una proteccion en caso de que uno de los numeros sea justo 1.
                const index2 = Math.min(Math.floor(num2 * x), x - 1);

                observedFrecuencies[index1][index2]++;
            }

            // Calcular chi-cuadrado
            let chiSquared = 0;

            for (let i = 0; i < x; i++) {
                for (let j = 0; j < x; j++) {
                    chiSquared += Math.pow(observedFrecuencies[i][j] - expectedFrecuency, 2) / expectedFrecuency;
                }
            }
        
            // Grados de libertad
            const df = Math.pow(x, 2) - 1;

            // Valores críticos aproximados para chi-cuadrado
            let criticalValue;
            if (alpha === 0.01) {
                if (df === 3) criticalValue = 11.34;
                else if (df === 8) criticalValue = 20.09;
                else if (df === 15) criticalValue = 30.58;
                else criticalValue = df + 3 * Math.sqrt(2 * df); // Aproximación para otros valores
            } else if (alpha === 0.05) {
                if (df === 3) criticalValue = 7.81;
                else if (df === 8) criticalValue = 15.51;
                else if (df === 15) criticalValue = 24.99;
                else criticalValue = df + 2 * Math.sqrt(2 * df); // Aproximación para otros valores
            } else { // alpha = 0.10
                if (df === 3) criticalValue = 6.25;
                else if (df === 8) criticalValue = 13.36;
                else if (df === 15) criticalValue = 22.31;
                else criticalValue = df + Math.sqrt(2 * df); // Aproximación para otros valores
            }

            const passed = chiSquared <= criticalValue;

            return {
                testName: "Prueba de la Serie",
                n: n,
                x: x,
                chiSquared: chiSquared,
                criticalValue: criticalValue,
                alpha: alpha,
                passed: passed,
                conclusion: passed ?
                    "Los números pasan la prueba de serie (no hay evidencia de correlación serial)" :
                    "Los números NO pasan la prueba de serie (hay evidencia de correlación serial)"
            };
        }
        
        //revisado
        // Prueba de Kolmogorov-Smirnov
        const kolmogorovSmirnovTest = (numbers, alpha)=> {
            const n = numbers.length; //tamano de la muestra
        
            const sorted = [...numbers].sort((a, b) => a - b); //ordenar en forma ascendente la muestra

            const Fn = sorted.map((x, i) => (i + 1) / n); //calcular la Distribucion Acumulada Fn(x)

            const F = sorted.map(x => x); // F(x) = x en distribución uniforme
        
            const differences = Fn.map((fn, i) => Math.abs(fn - F[i])); //calcular las diferencias absolutas entre Fn y F
        
            const D = Math.max(...differences); //calcular la máxima diferencia D

            // Valores críticos para Kolmogorov-Smirnov
            let criticalValue;
            if (alpha === 0.01) {
                criticalValue = 1.63 / Math.sqrt(n);
            } else if (alpha === 0.05) {
                criticalValue = 1.36 / Math.sqrt(n);
            } else { // alpha = 0.10
                criticalValue = 1.22 / Math.sqrt(n);
            }

            const passed = D <= criticalValue;

            return {
                testName: "Prueba de Kolmogorov-Smirnov",
                n: n,
                D: D,
                criticalValue: criticalValue,
                alpha: alpha,
                passed: passed,
                conclusion: passed ?
                    "Los números pasan la prueba de Kolmogorov-Smirnov (no hay evidencia para rechazar la hipótesis de uniformidad)" :
                    "Los números NO pasan la prueba de Kolmogorov-Smirnov (se rechaza la hipótesis de uniformidad)"
            };
        }
        
        // Prueba de Corridas Arriba/Abajo de la Media
        function runsAboveBelowMeanTest(numbers, alpha) {
            const n = numbers.length;
            const mean = 0.5; // Para distribución uniforme (0,1)
            
            // Crear secuencia de '+' y '-'
            let sequence = [];
            for (const num of numbers) {
                sequence.push(num >= mean ? '+' : '-');
            }
            
            // Contar corridas
            let runs = 1;
            for (let i = 1; i < sequence.length; i++) {
                if (sequence[i] !== sequence[i - 1]) {
                    runs++;
                }
            }
            
            // Calcular valores esperados y varianza
            const n1 = sequence.filter(s => s === '+').length;
            const n2 = sequence.filter(s => s === '-').length;
            
            const expectedRuns = (2 * n1 * n2) / (n1 + n2) + 1;
            const varianceRuns = (2 * n1 * n2 * (2 * n1 * n2 - n1 - n2)) / 
                                (Math.pow(n1 + n2, 2) * (n1 + n2 - 1));
            
            // Estadístico Z
            const z = (runs - expectedRuns) / Math.sqrt(varianceRuns);
            
            // Valor crítico Z (dos colas)
            let criticalValue;
            if (alpha === 0.01) criticalValue = 2.576;
            else if (alpha === 0.05) criticalValue = 1.96;
            else criticalValue = 1.645; // alpha = 0.10
            
            const passed = Math.abs(z) <= criticalValue;
            
            return {
                testName: "Prueba de Corridas Arriba/Abajo de la Media",
                n: n,
                runs: runs,
                expectedRuns: expectedRuns,
                zValue: z,
                criticalValue: criticalValue,
                alpha: alpha,
                passed: passed,
                conclusion: passed ?
                    "Los números pasan la prueba de corridas (no hay evidencia de patrones no aleatorios)" :
                    "Los números NO pasan la prueba de corridas (hay evidencia de patrones no aleatorios)"
            };
        }
        
        function displayTestResult(result) {
            const testResultDiv = document.getElementById("testResult");
            testResultDiv.innerHTML = "";
            
            const title = document.createElement("h3");
            title.textContent = result.testName;
            testResultDiv.appendChild(title);
            
            if (result.error) {
                const errorP = document.createElement("p");
                errorP.style.color = "red";
                errorP.textContent = result.error;
                testResultDiv.appendChild(errorP);
                return;
            }
            
            const details = document.createElement("div");
            
            // Mostrar detalles específicos de cada prueba
            if (result.testName === "Prueba de los Promedios") {
                details.innerHTML = `
                    <p>Número de muestras (n): ${result.n}</p>
                    <p>Media observada: ${result.mean.toFixed(6)}</p>
                    <p>Media esperada: ${result.expectedMean.toFixed(6)}</p>
                    <p>Valor Z calculado: ${result.zValue.toFixed(6)}</p>
                    <p>Valor crítico Z (α = ${result.alpha}): <span class="critical-value">±${result.criticalValue.toFixed(3)}</span></p>
                `;
            } else if (result.testName === "Prueba de la Frecuencia (Chi-cuadrado)") {
                details.innerHTML = `
                    <p>Número de muestras (n): ${result.n}</p>
                    <p>Número de intervalos (k): ${result.k}</p>
                    <p>Chi-cuadrado calculado: ${result.chiSquared.toFixed(6)}</p>
                    <p>Valor crítico (α = ${result.alpha}, df = ${result.k - 1}): <span class="critical-value">${result.criticalValue.toFixed(3)}</span></p>
                `;
            } else if (result.testName === "Prueba de la Serie") {
                details.innerHTML = `
                    <p>Número de muestras (n): ${result.n}</p>
                    <p>Número de intervalos (x): ${result.x}</p>
                    <p>Chi-cuadrado calculado: ${result.chiSquared.toFixed(6)}</p>
                    <p>Valor crítico (α = ${result.alpha}, df = ${result.x * result.x - 1}): <span class="critical-value">${result.criticalValue.toFixed(3)}</span></p>
                `;
            } else if (result.testName === "Prueba de Kolmogorov-Smirnov") {
                details.innerHTML = `
                    <p>Número de muestras (n): ${result.n}</p>
                    <p>D = ${result.D.toFixed(6)}</p>
                    <p>Valor crítico (α = ${result.alpha}): <span class="critical-value">${result.criticalValue.toFixed(6)}</span></p>
                `;
            } else if (result.testName === "Prueba de Corridas Arriba/Abajo de la Media") {
                details.innerHTML = `
                    <p>Número de muestras (n): ${result.n}</p>
                    <p>Número de corridas observadas: ${result.runs}</p>
                    <p>Número de corridas esperadas: ${result.expectedRuns.toFixed(6)}</p>
                    <p>Valor Z calculado: ${result.zValue.toFixed(6)}</p>
                    <p>Valor crítico Z (α = ${result.alpha}): <span class="critical-value">±${result.criticalValue.toFixed(3)}</span></p>
                `;
            }
            
            testResultDiv.appendChild(details);
            
            const conclusion = document.createElement("div");
            conclusion.className = `conclusion ${result.passed ? 'passed' : 'failed'}`;
            conclusion.textContent = result.conclusion;
            testResultDiv.appendChild(conclusion);
        }
    </script>
</body>
</html>